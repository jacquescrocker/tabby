on theSplit(theString, theDelimiter)
    set oldDelimiters to AppleScript's text item delimiters
    set AppleScript's text item delimiters to theDelimiter
    set theArray to every text item of theString
    set AppleScript's text item delimiters to oldDelimiters
    return theArray
end theSplit

-- via https://www.iterm2.com/documentation-scripting.html
on IsModernVersion(version)
    set myArray to my theSplit(version, ".")
    set major to item 1 of myArray
    set minor to item 2 of myArray
    set veryMinor to item 3 of myArray

    if major < 2 then
        return false
    end if
    if major > 2 then
        return true
    end if
    if minor < 9 then
        return false
    end if
    if minor > 9 then
        return true
    end if
    if veryMinor < 20140903 then
        return false
    end if
    return true
end IsModernVersion

tell application "iTerm2"
    if my IsModernVersion(version) then
        tell current window
            create tab with default profile
            tell the current session
                set name to "<%= title %>"
                write text "cd \"<%= basedir %>\" && clear"
                <%= commands %>
            end tell
        end tell
    else
        if (count of terminals) is equal to 0 then
            set term to (make new terminal)
        else
            set term to (current terminal)
        end if

        tell term
            tell (current session)
                write text "cd <%= basedir %>"
                write text "clear"
            end tell

            tell (launch session "Default")
                set name to "<%= title %>"
                write text "cd <%= basedir %>"
                write text "clear"
                <%= commands %>
            end tell
        end tell
    end if
end tell
